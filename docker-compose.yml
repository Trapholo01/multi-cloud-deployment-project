version: '3.8'

services:
  ci-pipeline:
    build:
      context: .
      dockerfile: Dockerfile.pipeline
    container_name: multi-cloud-pipeline
    volumes:
      - .:/workspace:rw
      - ./artifacts:/artifacts:rw
    environment:
      - NODE_ENV=production
      - NODE_VERSION=18
    command: ["/scripts/run-pipeline.sh"]
    
  pipeline-test:
    build:
      context: .
      dockerfile: Dockerfile.pipeline
    container_name: pipeline-test
    volumes:
      - .:/workspace:rw
      - ./artifacts:/artifacts:rw
    command: ["/scripts/test-deployment.sh"]
    depends_on:
      - ci-pipeline